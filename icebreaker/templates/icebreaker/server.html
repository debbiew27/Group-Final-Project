{% load static %}

<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Final Project: Implementation Prototype</title>
	<script type="text/javascript" src="{% static 'coloring/vendors/jquery/jquery-3.3.1.min.js' %}"></script>
  <link href="{% static 'coloring/vendors/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet" type="text/css" />
  
  <style type="text/css">
    #myCanvas {
      border: 1px solid black;
    }
  </style>
  
</head>
<body>


  
  <div class="container">
    
    <div class="row">
      <div class="col-12">
        <h1>Lobby</h1> 
         <div id="new_players"></div>
          <br></br>
        
        <button id="startGame"> Start Game</button>
    </div>
  </div>
  <script>
    window.onload = function() {
      const userMap = new Map()
      $('#startGame').on("click", function(event){
        console.log("clicked Start game")
        // Display "Answer survey on your phone!"
        $.ajax({
            type: "GET",
            url: "/icebreaker/default",
            success: populateUsers
        })
        
        // give the players their surveys
        
      })
      
      function populateUsers(response) {
        console.log("epic")
        var all_players = response["players"]
        for(var j = 0; j < all_players.length; j++) {
          let current = all_players[j.toString()];
          userMap.set(current["userhash"], current);
        } 
        console.log("USERS: ", userMap)
      }
      
      // TODO: CHANGE
      // const userData = new Map();
      function runServer(){
        // Receive a message from websocket server
        // Admin: Map ID to name & assigned questions and answers,
        // Establish websocket connection
        
        var socket = new WebSocket("wss://ws-server-template.debbiew27.repl.co", "very-good-protocol");
        socket.onmessage = function(message) {
          let userData = message.data.split('_')
          let username = userData[0]
          let topic = userData[1]
          let userhash = userData[2]

          console.log(message.data)
          
          // userData.set(userHash, [username])          

          var data_to_send = {
            "username": username,
            "userhash": userhash,
            "topic": topic
          };
          console.log(username, topic, userhash)
          //This ajax request sends a POST request to the server
          
          $.ajax({
            type: "POST",
            url: "/icebreaker/"+ username + "/",
            data: JSON.stringify(data_to_send),
            success: function (response) {
              // prints the response from the server
              console.log(response); 
              
            }
          });

          
          $("#new_players").append(`${username}`);
          $("#new_players").append($("<br>"));
          
        }
      }

      
      function init(){
        // TODO
        runServer(); 
      }

      init();
  }

</script>
</body>
</html>